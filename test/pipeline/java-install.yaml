name: Java installation

parameters:
  - name: flavor
    type: string
  - name: version
    type: string

variables:
  - name: archive_path
    value: $(Pipeline.Workspace)/openjdk.tar.gz
  - name: jdk_version_tag
    value: jdk-21.0.7+6

jobs:
  - job: test
    pool:
      name: github-actions
      demands:
        - flavor_${{ parameters.flavor }}
        - version_${{ parameters.version }}
    steps:
      - bash: |
          # Detect libc / distro
          if ldd --version 2>&1 | grep -qi musl; then
            suffix="alpine-linux"  # musl = Alpine
          else
            suffix="linux"  # glibc distros
          fi

          # Build download URL (example: OpenJDK21U-jdk_x64_alpine-linux_hotspot_21.0.2_13.tar.gz)
          file="OpenJDK21U-jdk_x64_${suffix}_hotspot_21.0.2_13.tar.gz"
          url="https://github.com/adoptium/temurin21-binaries/releases/download/${JDK_TAG}/${file}"
          echo "Fetching ${url}"
          curl -LsSf "${url}" -o "${ARCHIVE_PATH}"
        env:
          JDK_TAG: ${{ variables.jdk_version_tag }}
          ARCHIVE_PATH: ${{ variables.archive_path }}
        displayName: Download Eclipse Temurin

      - task: JavaToolInstaller@0
        inputs:
          jdkArchitectureOption: x64
          jdkFile: ${{ variables.archive_path }}
          jdkSourceOption: LocalDirectory
          versionSpec: 21

      - bash: |
          java --version | grep -q "^openjdk 21"
        displayName: Test Java installation
