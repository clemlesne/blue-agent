{{- if and (.Values.autoscaling.enabled) (.Capabilities.APIVersions.Has "keda.sh/v1alpha1") -}}
# Template Container for KEDA Autoscaling
# This pod serves as a "parent" agent that KEDA uses to monitor the Azure DevOps pool
# It registers with Azure DevOps for 1 minute to establish pool connection and then terminates
# This is essential for KEDA to determine when to scale up/down based on job queue
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "blue-agent.fullname" . }}-{{ .Release.Revision }}
  labels:
    {{- include "blue-agent.labels" . | nindent 4 }}
  annotations:
    # Cluster autoscaler never evicts this Pod
    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    {{- with .Values.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- $data := dict
    "azpAgentName" (dict "value" (include "blue-agent.fullname" .))
    "isTemplateJob" "1"
    "restartPolicy" "Never"
  }}
  {{- include "blue-agent.podSharedTemplate" (merge (dict "Args" $data) . ) | nindent 2 }}
{{- end }}
